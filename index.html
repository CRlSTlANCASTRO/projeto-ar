<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR - Soma com 3 Marcadores (Otimizado)</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/2.1.8/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      .debug-info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background: rgba(0,0,0,0.5);
        padding: 10px;
        z-index: 1000;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <div class="debug-info" id="debug">Nenhum marcador detectado</div>

    <a-scene
      embedded
      arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
    >
      <!-- Iluminação -->
      <a-light type="ambient" intensity="0.8"></a-light>
      <a-light type="directional" intensity="0.5" position="-1 1 2"></a-light>

      <!-- Marcador Número 1 -->
      <a-marker id="marker1" type="pattern" url="markers/pattern-marker-1.patt" emit-events="true" data-value="1">
        <a-text value="1" position="0 0.5 0" scale="3 3 3" color="red"></a-text>
      </a-marker>

      <!-- Marcador Sinal de Adição -->
      <a-marker id="markerPlus" type="pattern" url="markers/pattern-marker-plus.patt" emit-events="true">
        <a-text value="+" position="0 0.5 0" scale="3 3 3" color="yellow"></a-text>
      </a-marker>

      <!-- Marcador Número 2 -->
      <a-marker id="marker2" type="pattern" url="markers/pattern-marker-2.patt" emit-events="true" data-value="2">
        <a-text value="2" position="0 0.5 0" scale="3 3 3" color="blue"></a-text>
      </a-marker>

      <!-- Resultado exibido no centro da cena -->
      <a-entity id="resultText" position="0 1 0">
        <a-text value="" color="green" scale="4 4 4" align="center"></a-text>
      </a-entity>

      <!-- Câmera -->
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const debugDiv = document.getElementById('debug');
      const resultText = document.querySelector('#resultText a-text');

      // Estado global dos marcadores (true = visível, false = oculto)
      const markerStates = {
        marker1: false,
        markerPlus: false,
        marker2: false
      };

      // Tempo de confirmação (em ms) para evitar falsos positivos
      const CONFIRMATION_DELAY = 300;

      // Configura eventos para cada marcador com confirmação por delay
      function setupMarkerWithConfirmation(markerId) {
        const marker = document.querySelector(`#${markerId}`);
        let timeoutId;

        marker.addEventListener('markerFound', () => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            markerStates[markerId] = true;
            updateResult();
            updateDebugInfo();
          }, CONFIRMATION_DELAY);
        });

        marker.addEventListener('markerLost', () => {
          clearTimeout(timeoutId);
          markerStates[markerId] = false;
          updateResult();
          updateDebugInfo();
        });
      }

      // Inicializa todos os marcadores
      Object.keys(markerStates).forEach(setupMarkerWithConfirmation);

      // Atualiza o resultado da soma se todos os marcadores estiverem visíveis
      function updateResult() {
        if (markerStates.marker1 && markerStates.markerPlus && markerStates.marker2) {
          const val1 = parseInt(document.querySelector('#marker1').getAttribute('data-value'));
          const val2 = parseInt(document.querySelector('#marker2').getAttribute('data-value'));
          resultText.setAttribute('value', `${val1} + ${val2} = ${val1 + val2}`);
        } else {
          resultText.setAttribute('value', '');
        }
      }

      // Atualiza o painel de debug
      function updateDebugInfo() {
        const activeMarkers = Object.keys(markerStates).filter(id => markerStates[id]);
        debugDiv.textContent = activeMarkers.length
          ? `Marcadores ativos: ${activeMarkers.join(', ')}`
          : 'Nenhum marcador detectado';
      }
    </script>
  </body>
</html>